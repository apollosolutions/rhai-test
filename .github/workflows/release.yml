name: Build and Release

on: workflow_dispatch

defaults:
  run:
    # necessary for windows
    shell: bash

jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4.1.7
        - uses: actions-rust-lang/setup-rust-toolchain@v1
        - uses: arduino/setup-protoc@v3
          with:
            repo-token: ${{ secrets.GITHUB_TOKEN }}
        - name: Running examples
          run: |
              cargo run
    
    prepare-release:
      needs: test
      runs-on: ubuntu-latest
      outputs:
        sha: ${{ steps.commit.outputs.sha }}
      steps:
        - uses: actions/checkout@v4.1.7
          name: Fetch entire history (for conventional commits)
          with:
            fetch-depth: 0
        - name: Configure Git
          run: |
            git config --global user.name GitHub Actions
            git config user.email github-actions@github.com
        - name: Install Knope
          uses: knope-dev/action@v2.1.0
          with:
            version: 0.18.0
        - run: knope prepare-release --verbose
          name: Update versioned files and changelog
        - name: Store commit
          id: commit
          run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
              
    build-artifacts:
        needs: prepare-release
        strategy:
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                    - target: aarch64-apple-darwin
                      os: macos-latest
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
        runs-on: ${{ matrix.os }}
        env:
            archive_name: rhai-test
        steps:
            - uses: actions/checkout@v4
              with:
                ref: ${{ needs.prepare-release.outputs.sha }}
            
            - uses: actions-rust-lang/setup-rust-toolchain@v1
            
            - uses: arduino/setup-protoc@v3
              with:
                repo-token: ${{ secrets.GITHUB_TOKEN }}

            # Authenticate to GCP using Workload Identity Federation.
            # We set up the WI provider in the `github_actions_federation` resource in the
            # `platform-infrastructure` repository.
            - id: google-auth
              uses: 'google-github-actions/auth@v2'
              with:
                workload_identity_provider: 'projects/865738624352/locations/global/workloadIdentityPools/github-d8bck/providers/github-d8bck'
                service_account: apollosolution-rhai-test@platform-mgmt-service-e0izz.iam.gserviceaccount.com
                project_id: platform-cross-environment

            # Gets some secrets from Google Secret Manager.
            - id: gsm-secrets
              uses: 'google-github-actions/get-secretmanager-secrets@v2'
              with:
                # The format of each line here is OUTPUTNAME:PROJECT/SECRET; you can
                # read the secrets later in this file with
                # `steps.gsm-secrets.outputs.OUTPUTNAME`. These secrets are created in
                # the `argo` resource in the `domain-deployment` repository.
                secrets: |-
                  MACOS_CERT_BUNDLE_PASSWORD:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_CERT_BUNDLE_PASSWORD
                  MACOS_CERT_BUNDLE_BASE64:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_CERT_BUNDLE_BASE64
                  MACOS_NOTARIZATION_PASSWORD:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_NOTARIZATION_PASSWORD
                  MACOS_KEYCHAIN_PASSWORD:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_KEYCHAIN_PASSWORD
            
            - name: Build
              run: cargo build --release --target ${{ matrix.target }}
            
            - name: Create Archive Folder
              run: mkdir ${{ env.archive_name }}
            
            - name: Copy Unix Artifact
              if: ${{ matrix.os != 'windows-latest' }}
              run: cp target/${{ matrix.target }}/release/${{ env.archive_name }} ${{ env.archive_name }}
      
            - name: Copy Windows Artifact
              if: ${{ matrix.os == 'windows-latest' }}
              run: cp target/${{ matrix.target }}/release/${{ env.archive_name }}.exe ${{ env.archive_name }}
            
            - name: Create Tar Archive
              run: tar -czf ${{ env.archive_name }}-${{ matrix.target }}.tgz ${{ env.archive_name }}

            - name: Upload Artifact
              uses: actions/upload-artifact@v4.4.0
              with:
                name: ${{ matrix.target }}
                path: ${{ env.archive_name }}-${{ matrix.target }}.tgz
                if-no-files-found: error
    release:
      needs: [build-artifacts, prepare-release]
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4.1.7
          with:
            ref: ${{ needs.prepare-release.outputs.sha }}
        - uses: actions/download-artifact@v4.1.8
          with:
            path: artifacts
            merge-multiple: true
        - run: |
            cd artifacts
            ls
            cd ..
        - name: Install the latest Knope
          uses: knope-dev/action@v2.1.0
          with:
            version: 0.11.0
        - run: knope release --verbose
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}