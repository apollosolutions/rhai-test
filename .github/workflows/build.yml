name: Test Building for Apple

on: workflow_dispatch

defaults:
  run:
    # necessary for windows
    shell: bash

jobs:              
    build-artifacts:
        strategy:
            matrix:
                include:
                    - target: aarch64-apple-darwin
                      os: macos-latest
        runs-on: ${{ matrix.os }}
        env:
            archive_name: rhai-test
        steps:
            - uses: actions/checkout@v4
            
            - uses: actions-rust-lang/setup-rust-toolchain@v1
            
            - uses: arduino/setup-protoc@v3
              with:
                repo-token: ${{ secrets.GITHUB_TOKEN }}

            # Authenticate to GCP using Workload Identity Federation.
            # We set up the WI provider in the `github_actions_federation` resource in the
            # `platform-infrastructure` repository.
            - id: google-auth
              uses: 'google-github-actions/auth@v2'
              with:
                workload_identity_provider: 'projects/865738624352/locations/global/workloadIdentityPools/github-d8bck/providers/github-d8bck'
                service_account: apollosolution-rhai-test@platform-mgmt-service-e0izz.iam.gserviceaccount.com
                project_id: platform-cross-environment

            # Gets some secrets from Google Secret Manager.
            - id: gsm-secrets
              uses: 'google-github-actions/get-secretmanager-secrets@v2'
              with:
                # The format of each line here is OUTPUTNAME:PROJECT/SECRET; you can
                # read the secrets later in this file with
                # `steps.gsm-secrets.outputs.OUTPUTNAME`. These secrets are created in
                # the `argo` resource in the `domain-deployment` repository.
                secrets: |-
                  MACOS_CERT_BUNDLE_PASSWORD:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_CERT_BUNDLE_PASSWORD
                  MACOS_CERT_BUNDLE_BASE64:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_CERT_BUNDLE_BASE64
                  MACOS_NOTARIZATION_PASSWORD:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_NOTARIZATION_PASSWORD
                  MACOS_KEYCHAIN_PASSWORD:platform-mgmt-secrets-3xnc4/apollosolutions-rhai-test-MACOS_KEYCHAIN_PASSWORD
            
            - name: Build
              run: cargo build --release --target ${{ matrix.target }}